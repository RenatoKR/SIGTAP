name: Sync DATASUS TUP

on:
  schedule:
    - cron: '0 8 * * *'  # Diariamente √†s 8h UTC (5h BRT)
  workflow_dispatch:  # Permite executar manualmente

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Install lftp
        run: sudo apt-get install -y lftp
        
      - name: Download TabelaUnificada ZIPs (√∫ltimos 6)
        run: |
          mkdir -p tabelas
          cd tabelas
          
          lftp -c "
          set ftp:ssl-allow no;
          open ftp://anonymous:@ftp2.datasus.gov.br;
          cd /pub/sistemas/tup/downloads;
          cls -1 TabelaUnificada_*.zip > /tmp/arquivos.txt
          "
          
          tail -n 6 /tmp/arquivos.txt > /tmp/ultimos6.txt
          
          echo "üì• Arquivos a serem baixados:"
          cat /tmp/ultimos6.txt
          
          while IFS= read -r arquivo; do
            if [ ! -f "$arquivo" ]; then
              echo "‚¨áÔ∏è  Baixando: $arquivo"
              lftp -c "
              set ftp:ssl-allow no;
              open ftp://anonymous:@ftp2.datasus.gov.br;
              cd /pub/sistemas/tup/downloads;
              get -c \"$arquivo\"
              "
            else
              echo "‚úÖ J√° existe: $arquivo"
            fi
          done < /tmp/ultimos6.txt
          
      - name: Download notas t√©cnicas completas
        run: |
          lftp -c "
          set ftp:ssl-allow no;
          open ftp://anonymous:@ftp2.datasus.gov.br;
          mirror -v --only-newer --parallel=3 /pub/sistemas/tup/downloads/notastecnicas ./notastecnicas
          "
      
      - name: Clean old files
        run: |
          cd tabelas
          for arquivo in TabelaUnificada_*.zip; do
            if [ -f "$arquivo" ] && ! grep -q "$arquivo" /tmp/ultimos6.txt; then
              echo "üóëÔ∏è  Removendo arquivo antigo: $arquivo"
              rm "$arquivo"
            fi
          done
      
      - name: Generate file statistics
        run: |
          echo "TOTAL_SIZE=$(du -sh tabelas | cut -f1)" >> $GITHUB_ENV
          echo "NOTAS_COUNT=$(find notastecnicas -type f | wc -l)" >> $GITHUB_ENV
          echo "TABELAS_COUNT=$(ls -1 tabelas/*.zip 2>/dev/null | wc -l)" >> $GITHUB_ENV
          echo "LAST_UPDATE=$(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S BRT')" >> $GITHUB_ENV
      
      - name: Generate README with file list
        run: |
          cat > README.md << EOF
          # üìä DATASUS - Tabela Unificada SIGTAP
          
          [![Sync Status](https://github.com/${{ github.repository }}/actions/workflows/sync-datasus.yml/badge.svg)](https://github.com/${{ github.repository }}/actions/workflows/sync-datasus.yml)
          [![√öltima Atualiza√ß√£o](https://img.shields.io/badge/√∫ltima%20atualiza√ß√£o-$(date -u '+%Y--%m--%d')-blue)](https://github.com/${{ github.repository }}/commits/main)
          
          Reposit√≥rio automatizado com mirror dos arquivos da **Tabela Unificada do Sistema de Gerenciamento da Tabela de Procedimentos (SIGTAP)** do DATASUS.
          
          ## üì¶ Tabelas Unificadas (√öltimos 6 Meses)
          
          > **Total:** $TABELAS_COUNT arquivos | **Tamanho:** $TOTAL_SIZE
          
          | Arquivo | Per√≠odo | Tamanho | Download |
          |---------|---------|---------|----------|
          EOF
          
          cd tabelas
          for arquivo in $(ls -r TabelaUnificada_*.zip 2>/dev/null); do
            # Extrai ano/m√™s do nome (ex: TabelaUnificada_202601_v2601221740.zip)
            periodo=$(echo "$arquivo" | grep -oP '(?<=TabelaUnificada_)\d{6}')
            ano=${periodo:0:4}
            mes=${periodo:4:2}
            
            # Formata m√™s
            case $mes in
              01) mes_nome="Janeiro" ;;
              02) mes_nome="Fevereiro" ;;
              03) mes_nome="Mar√ßo" ;;
              04) mes_nome="Abril" ;;
              05) mes_nome="Maio" ;;
              06) mes_nome="Junho" ;;
              07) mes_nome="Julho" ;;
              08) mes_nome="Agosto" ;;
              09) mes_nome="Setembro" ;;
              10) mes_nome="Outubro" ;;
              11) mes_nome="Novembro" ;;
              12) mes_nome="Dezembro" ;;
            esac
            
            tamanho=$(ls -lh "$arquivo" | awk '{print $5}')
            url="https://github.com/${{ github.repository }}/raw/main/tabelas/$arquivo"
            
            echo "| \`$arquivo\` | $mes_nome/$ano | $tamanho | [‚¨áÔ∏è Download]($url) |" >> ../README.md
          done
          cd ..
          
          cat >> README.md << EOF
          
          ## üìÑ Notas T√©cnicas
          
          > **Total:** $NOTAS_COUNT documentos
          
          Todas as notas t√©cnicas dispon√≠veis est√£o na pasta [\`notastecnicas/\`](./notastecnicas/)
          
          ### √öltimas Notas
          
          EOF
          
          find notastecnicas -type f -name "*.pdf" | sort -r | head -5 | while read -r nota; do
            nome=$(basename "$nota")
            url="https://github.com/${{ github.repository }}/blob/main/$nota"
            echo "- [\`$nome\`]($url)" >> README.md
          done
          
          cat >> README.md << 'EOF'
          
          ## üìñ Sobre o SIGTAP
          
          A Tabela Unificada do SIGTAP cont√©m:
          - Procedimentos m√©dicos e odontol√≥gicos
          - Medicamentos e OPM (√ìrteses, Pr√≥teses e Materiais Especiais)
          - Valores de reembolso do SUS
          - CID-10 e compatibilidades
          - Habilita√ß√µes e classifica√ß√µes
          
          ## üîÑ Atualiza√ß√£o Autom√°tica
          
          Este reposit√≥rio √© atualizado **diariamente √†s 5h (hor√°rio de Bras√≠lia)** via GitHub Actions.
          
          **Fonte oficial:** [FTP DATASUS](ftp://ftp2.datasus.gov.br/pub/sistemas/tup/downloads/)
          
          ## üíª Como Usar
          
          ### Download via wget/curl
          ```bash
          # √öltima tabela dispon√≠vel
          wget https://github.com/${{ github.repository }}/raw/main/tabelas/TabelaUnificada_202601_v2601221740.zip
          ```
          
          ### Clone do reposit√≥rio
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          cd SIGTAP/tabelas
          ```
          
          ### GitHub API (program√°tico)
          ```bash
          curl -s https://api.github.com/repos/${{ github.repository }}/contents/tabelas | jq -r '.[].download_url'
          ```
          
          ## üìä Estrutura dos Arquivos
          
          ```
          SIGTAP/
          ‚îú‚îÄ‚îÄ tabelas/                    # Tabelas unificadas (6 mais recentes)
          ‚îÇ   ‚îî‚îÄ‚îÄ TabelaUnificada_*.zip
          ‚îî‚îÄ‚îÄ notastecnicas/              # Documenta√ß√£o t√©cnica oficial
              ‚îî‚îÄ‚îÄ *.pdf
          ```
          
          ## ‚öñÔ∏è Licen√ßa e Dados P√∫blicos
          
          Os dados s√£o de **dom√≠nio p√∫blico** e mantidos pelo Minist√©rio da Sa√∫de do Brasil.
          Este reposit√≥rio apenas facilita o acesso aos arquivos oficiais.
          
          ---
          
          <div align="center">
          
          EOF
          
          echo "**ü§ñ Atualizado automaticamente** | √öltima execu√ß√£o: $LAST_UPDATE" >> README.md
          echo "" >> README.md
          echo "</div>" >> README.md
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Sincroniza com o remoto primeiro
          git fetch origin main
          git reset --soft origin/main
          
          git add -A
          
          if ! git diff --staged --quiet; then
            CHANGES=$(git diff --staged --name-status | head -10)
            
            git commit -m "üîÑ Atualiza√ß√£o autom√°tica - $(date -u '+%Y-%m-%d %H:%M')" \
                       -m "Altera√ß√µes:" \
                       -m "$CHANGES"
            
            # Push com retry em caso de conflito
            for i in {1..3}; do
              if git push origin HEAD:main; then
                echo "‚úÖ Altera√ß√µes enviadas com sucesso"
                break
              else
                echo "‚ö†Ô∏è  Tentativa $i falhou, sincronizando..."
                git fetch origin main
                git rebase origin/main
                sleep 2
              fi
            done
          else
            echo "‚ÑπÔ∏è  Nenhuma altera√ß√£o detectada"
          fi
